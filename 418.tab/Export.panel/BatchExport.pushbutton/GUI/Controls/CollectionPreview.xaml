<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <!-- 
       TEMPLATE PRINCIPAL : CollectionPreviewTemplate
       Ce template dÃ©finit l'interface utilisateur pour la prÃ©visualisation des collections Ã  exporter.
       Il est utilisÃ© par le composant CollectionPreviewComponent.
  -->
  <ControlTemplate x:Key="CollectionPreviewTemplate" TargetType="ContentControl">
    <ControlTemplate.Resources>
      <!-- Convertisseur pour afficher/masquer des Ã©lÃ©ments basÃ©s sur un boolÃ©en -->
      <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

      <!-- 
           STYLE DE L'EXPANDER (GROUPE)
           Personnalisation du style des groupes (Collections) dans la ListView.
           Il remplace le style par dÃ©faut pour avoir un look plus "Fluent" / moderne.
      -->
      <Style x:Key="FluentGroupExpanderStyle" TargetType="{x:Type Expander}">
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
        <Setter Property="BorderThickness" Value="0,0,0,1"/>
        <Setter Property="BorderBrush" Value="{DynamicResource ControlBorderBrush}"/>
        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        <Setter Property="VerticalContentAlignment" Value="Stretch"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type Expander}">
                    <Border BorderThickness="{TemplateBinding BorderThickness}" 
                            BorderBrush="{TemplateBinding BorderBrush}"
                            Background="{TemplateBinding Background}">
                        <DockPanel>
                            <!-- 
                                 TOGGLE BUTTON (EN-TÃŠTE DU GROUPE)
                                 C'est la partie cliquable qui permet d'ouvrir/fermer le groupe.
                            -->
                            <ToggleButton x:Name="HeaderSite"
                                          DockPanel.Dock="Top"
                                          Background="Transparent"
                                          Content="{TemplateBinding Header}"
                                          ContentTemplate="{TemplateBinding HeaderTemplate}"
                                          ContentTemplateSelector="{TemplateBinding HeaderTemplateSelector}"
                                          Foreground="{TemplateBinding Foreground}"
                                          FontWeight="{TemplateBinding FontWeight}"
                                          FontStyle="{TemplateBinding FontStyle}"
                                          FontSize="{TemplateBinding FontSize}"
                                          FontFamily="{TemplateBinding FontFamily}"
                                          Padding="10,5"
                                          HorizontalContentAlignment="Stretch"
                                          IsChecked="{Binding IsExpanded, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                                        <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- IcÃ´ne de flÃ¨che (Chevron) qui tourne quand le groupe est ouvert -->
                                                <Border Width="24" Height="24" Background="Transparent">
                                                    <Path x:Name="arrow"
                                                          Data="M 0 0 L 4 4 L 0 8"
                                                          Stroke="{TemplateBinding Foreground}"
                                                          StrokeThickness="1.5"
                                                          HorizontalAlignment="Center"
                                                          VerticalAlignment="Center"
                                                          RenderTransformOrigin="0.5,0.5">
                                                        <Path.RenderTransform>
                                                            <RotateTransform Angle="0"/>
                                                        </Path.RenderTransform>
                                                    </Path>
                                                </Border>

                                                <!-- Contenu de l'en-tÃªte (dÃ©fini plus bas dans le GroupStyle) -->
                                                <ContentPresenter Grid.Column="1" 
                                                                  Content="{TemplateBinding Content}" 
                                                                  ContentTemplate="{TemplateBinding ContentTemplate}" 
                                                                  VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <!-- Changement d'apparence au survol -->
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource ControlFillHoverBrush}"/>
                                                <Setter Property="Cursor" Value="Hand"/>
                                            </Trigger>
                                            <!-- Rotation de la flÃ¨che quand le groupe est ouvert -->
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter TargetName="arrow" Property="RenderTransform">
                                                    <Setter.Value>
                                                        <RotateTransform Angle="90"/>
                                                    </Setter.Value>
                                                </Setter>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            
                            <!-- 
                                 CONTENU DU GROUPE (LISTE DES FEUILLES)
                                 C'est ici que s'affichent les Ã©lÃ©ments enfants du groupe.
                            -->
                            <ContentPresenter x:Name="ExpandSite"
                                              DockPanel.Dock="Bottom"
                                              Focusable="false"
                                              HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              Margin="{TemplateBinding Padding}"
                                              Visibility="Collapsed"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </DockPanel>
                    </Border>
                    <ControlTemplate.Triggers>
                        <!-- Affiche le contenu quand IsExpanded est vrai -->
                        <Trigger Property="IsExpanded" Value="true">
                            <Setter Property="Visibility" TargetName="ExpandSite" Value="Visible"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
        <Style.Triggers>
            <!-- Apparence quand le groupe est dÃ©sactivÃ© -->
            <Trigger Property="IsEnabled" Value="False">
                <Setter Property="Background" Value="#3f4655"/>
            </Trigger>
        </Style.Triggers>
      </Style>
    </ControlTemplate.Resources>
    
    <!-- CONTENEUR PRINCIPAL -->
    <StackPanel>
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 1 : EN-TÃŠTE ET PROGRESSION -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <TextBlock Text="Recapitulatif : " 
                  Foreground="{DynamicResource TextPrimaryBrush}"
                  FontWeight="Bold" Margin="0,0,0,6"/>
      
      <!-- Barre de progression globale de l'export -->
      <ProgressBar Name="ExportProgressBar"
                   Height="24" Minimum="0"
                   Maximum="100" Value="0" Margin="0,4,0,8"/>
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 2 : TABLEAU DE PRÃ‰VISUALISATION DES COLLECTIONS -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <Border BorderThickness="0" Margin="0,0,0,8">
        <StackPanel>
          <!-- Texte indiquant le nombre de collections et d'Ã©lÃ©ments trouvÃ©s -->
          <TextBlock Name="PreviewCounterText"
                     Margin="0,0,0,6"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     Text="Collections: 0 â€¢ Ã‰lÃ©ments: 0"/>
          
          <!-- 
               LISTVIEW PRINCIPALE
               Affiche les feuilles regroupÃ©es par Collection.
          -->
          <ListView Name="CollectionGrid"
                    Height="200"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                    BorderThickness="1"
                    BorderBrush="{DynamicResource ControlBorderBrush}">
            
            <!-- DÃ‰FINITION DES GROUPES (COLLECTIONS) -->
            <ListView.GroupStyle>
              <GroupStyle>
                <GroupStyle.ContainerStyle>
                  <Style TargetType="{x:Type GroupItem}">
                    <Setter Property="Template">
                      <Setter.Value>
                        <ControlTemplate TargetType="{x:Type GroupItem}">
                          <!-- Utilisation du style d'Expander dÃ©fini plus haut -->
                          <Expander Style="{StaticResource FluentGroupExpanderStyle}"
                                    IsExpanded="False"
                                    IsEnabled="{Binding Items[0][CollectionIsExported]}">
                            
                            <!-- EN-TÃŠTE DU GROUPE (Ligne de la Collection) -->
                            <Expander.Header>
                                <Grid Height="25" Width="850">
                                    <Grid.ColumnDefinitions>
                                      <ColumnDefinition Width="150"/>   <!-- Nom de la collection -->
                                      <ColumnDefinition Width="350"/>  <!-- Nom du fichier de sortie (preview) -->
                                      <ColumnDefinition Width="70"/>   <!-- Nombre de feuilles -->
                                      <ColumnDefinition Width="200"/>    <!-- Infos d'export -->
                                      <ColumnDefinition Width="30"/>   <!-- Bouton d'ordre -->
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Colonne 1 : Nom de la collection -->
                                    <TextBlock Grid.Column="0" Text="{Binding Name}"
                                              FontStyle="Italic" VerticalAlignment="Center" Margin="5,0"/>
                                    
                                    <!-- Colonne 2 : Nom du fichier gÃ©nÃ©rÃ© (si combinÃ©) -->
                                    <TextBlock Grid.Column="1" Text="{Binding Items[0][CollectionPreviewName]}" 
                                              FontWeight="Bold" VerticalAlignment="Center" Margin="5,0" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    
                                    <!-- Colonne 3 : Nombre de feuilles dans la collection -->
                                    <TextBlock Grid.Column="2" Text="{Binding Items[0][SheetCount], StringFormat='{}{0} feuilles'}"
                                              FontStyle="Italic"  VerticalAlignment="Center" Margin="5,0"/>
                                    
                                    <!-- Colonne 4 : RÃ©sumÃ© des options d'export (PDF, DWG, etc.) -->
                                    <TextBlock Grid.Column="3" Text="{Binding Items[0][CollectionExportInfo]}" 
                                              FontSize="10" VerticalAlignment="Center" Margin="5,0" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    
                                    <!-- Colonne 5 : Bouton pour gÃ©rer l'ordre (visible uniquement si combinÃ©) -->
                                    <Button Grid.Column="4" Content="ðŸ”ƒ" Width="20" Height="20" 
                                              Visibility="{Binding Items[0][IsCombined], Converter={StaticResource BoolToVisibilityConverter}}"
                                              Command="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=ManageOrderCommand}"
                                            CommandParameter="{Binding Name}"/>
                                </Grid>
                            </Expander.Header>
                            <ItemsPresenter />
                          </Expander>
                        </ControlTemplate>
                      </Setter.Value>
                    </Setter>
                  </Style>
                </GroupStyle.ContainerStyle>
              </GroupStyle>
            </ListView.GroupStyle>
            
            <!-- DÃ‰FINITION DES COLONNES (FEUILLES INDIVIDUELLES) -->
            <ListView.View>
              <GridView AllowsColumnReorder="True">
                <!-- Colonne 1 : NumÃ©ro de la feuille -->
                <GridViewColumn Header="numÃ©ro" Width="100" DisplayMemberBinding="{Binding [SheetNumber]}"/>
                <!-- Colonne 2 : Nom du fichier gÃ©nÃ©rÃ© pour cette feuille -->
                <GridViewColumn Header="nom d'export" Width="400" DisplayMemberBinding="{Binding [PreviewNom]}"/>
                <!-- Colonne 3 : Format de papier -->
                <GridViewColumn Header="Format" Width="70" DisplayMemberBinding="{Binding [Format]}"/>
                <!-- Colonne 4 : Dimensions -->
                <GridViewColumn Header="Taille" Width="70" DisplayMemberBinding="{Binding [Size]}"/>
                <!-- Colonne 5 : Orientation (Portrait/Paysage) -->
                <GridViewColumn Header="Orientation" Width="700" DisplayMemberBinding="{Binding [Orientation]}"/>
                <!-- Colonne 6 : Statut de progression de l'export -->
                <GridViewColumn Header="Progress" Width="70">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding [Progress]}" 
                                 Foreground="{Binding [ProgressColor]}"/>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
              </GridView>
            </ListView.View>
          </ListView>
        </StackPanel>
      </Border>
      
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- SECTION 3 : BARRE D'ACTION (Statut + Bouton Export) -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <DockPanel LastChildFill="False" Margin="0,8,0,0">
        <!-- Message de statut (erreurs, avertissements, succÃ¨s) -->
        <TextBlock Name="ExportStatusText"
                   VerticalAlignment="Center"
                   Margin="0,0,8,0"
                   TextWrapping="Wrap"
                   Width="Auto"
                   DockPanel.Dock="Left"
                   Foreground="Red"
                   Text="SÃ©lectionnez un dossier de destination valide."/>
        
        <!-- Bouton principal pour lancer l'exportation -->
        <Button Name="ExportButton"
                Content="Exporter"
                Height="32"
                MinWidth="120"
                HorizontalAlignment="Right"
                DockPanel.Dock="Right"
                IsEnabled="False"/>
      </DockPanel>
    </StackPanel>
  </ControlTemplate>
</ResourceDictionary>
