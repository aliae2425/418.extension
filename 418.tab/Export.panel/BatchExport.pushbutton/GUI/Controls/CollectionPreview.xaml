<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <ControlTemplate x:Key="CollectionPreviewTemplate" TargetType="ContentControl">
    <ControlTemplate.Resources>
      <!-- Convertisseur Boolean vers Visibility -->
      <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </ControlTemplate.Resources>
    <StackPanel>
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- EN-TÊTE ET PROGRESSION -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <TextBlock Text="Recapitulatif : " FontWeight="Bold" Margin="0,0,0,6"/>
      
      <!-- Barre de progression de l'export -->
      <ProgressBar Name="ExportProgressBar"
                   Height="24" Minimum="0"
                   Maximum="100" Value="0" Margin="0,4,0,8"/>
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- TABLEAU DE PRÉVISUALISATION DES COLLECTIONS -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <Border BorderThickness="0" Margin="0,0,0,8">
        <StackPanel>
          <!-- Compteur de collections et éléments -->
          <TextBlock Name="PreviewCounterText"
                     Margin="0,0,0,6"
                     Foreground="Gray"
                     Text="Collections: 0 • Éléments: 0"/>
          
          <!-- ListView avec GridView (style tableau) -->
          <ListView Name="CollectionGrid"
                    Height="200"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                    BorderThickness="1"
                    BorderBrush="LightGray">
            <ListView.View>
              <GridView AllowsColumnReorder="False">
                <!-- Colonne 1: Indicateur expand/collapse (▶/▼) -->
                <GridViewColumn Width="28">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <CheckBox Width="20" Height="20" 
                                IsChecked="{Binding [IsExpanded]}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">
                        <CheckBox.Template>
                          <ControlTemplate TargetType="CheckBox">
                            <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" 
                                       Foreground="Gray" FontSize="12" Cursor="Hand">
                              <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                  <Setter Property="Text" Value="▼"/>
                                  <Style.Triggers>
                                    <DataTrigger Binding="{Binding [IsExpanded]}" Value="False">
                                      <Setter Property="Text" Value="▶"/>
                                    </DataTrigger>
                                  </Style.Triggers>
                                </Style>
                              </TextBlock.Style>
                            </TextBlock>
                          </ControlTemplate>
                        </CheckBox.Template>
                      </CheckBox>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
                
                <!-- Colonne 2: Nom de la collection -->
                <GridViewColumn Header="Nom" Width="200" DisplayMemberBinding="{Binding [Nom]}"/>
                
                <!-- Colonne 3: Preview du nom de fichier -->
                <GridViewColumn Header="Preview Nom" Width="250" DisplayMemberBinding="{Binding [PreviewNom]}"/>
                
                <!-- Colonne 4: Nombre de feuilles -->
                <GridViewColumn Header="Feuilles" Width="80" DisplayMemberBinding="{Binding [Feuilles]}"/>
                
                <!-- Colonne 5: Export PDF (✓/✗) -->
                <GridViewColumn Header="Export" Width="70">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding [ExportText]}" 
                                 Foreground="{Binding [ExportColor]}" 
                                 HorizontalAlignment="Center"/>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
                
                <!-- Colonne 6: Export par feuille/Carnet (✓/✗) -->
                <GridViewColumn Header="Carnet" Width="70">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding [CarnetText]}" 
                                 Foreground="{Binding [CarnetColor]}" 
                                 HorizontalAlignment="Center"/>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
                
                <!-- Colonne 7: Export DWG (✓/✗) -->
                <GridViewColumn Header="DWG" Width="70">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding [DWGText]}" 
                                 Foreground="{Binding [DWGColor]}" 
                                 HorizontalAlignment="Center"/>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
                
                <!-- Colonne 8: Statut d'export -->
                <GridViewColumn Header="Statut" Width="150">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding [StatutText]}" 
                                 Foreground="{Binding [StatutColor]}"/>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
              </GridView>
            </ListView.View>
            
            <!-- Template pour afficher les détails quand IsExpanded = true -->
            <ListView.ItemContainerStyle>
              <Style TargetType="ListViewItem">
                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                <Setter Property="Template">
                  <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                      <StackPanel>
                        <!-- Ligne principale (collection) -->
                        <GridViewRowPresenter Content="{TemplateBinding Content}"
                                              Columns="{TemplateBinding GridView.ColumnCollection}"/>
                        
                        <!-- Détails (feuilles) - affichés si IsExpanded = true -->
                        <ItemsControl ItemsSource="{Binding [Details]}" 
                                      Margin="28,0,0,4"
                                      Visibility="{Binding [IsExpanded], Converter={StaticResource BoolToVisibilityConverter}}">
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <Grid Margin="0,2">
                                <Grid.ColumnDefinitions>
                                  <ColumnDefinition Width="200"/>
                                  <ColumnDefinition Width="250"/>
                                  <ColumnDefinition Width="80"/>
                                  <ColumnDefinition Width="70"/>
                                  <ColumnDefinition Width="70"/>
                                  <ColumnDefinition Width="70"/>
                                  <ColumnDefinition Width="150"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Grid.Column="0" Text="{Binding [SheetInfo]}" 
                                           Foreground="Gray" FontSize="11" Padding="4,2"/>
                                <TextBlock Grid.Column="1" Text="{Binding [PreviewNom]}" 
                                           Foreground="DarkBlue" FontSize="11" FontWeight="SemiBold" Padding="4,2"/>
                                <TextBlock Grid.Column="2" Text="{Binding [Format]}" 
                                           Foreground="Gray" FontSize="11" Padding="4,2"/>
                                <TextBlock Grid.Column="6" Text="{Binding [StatutText]}" 
                                           Foreground="{Binding [StatutColor]}" FontSize="11" Padding="4,2"/>
                              </Grid>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                      </StackPanel>
                    </ControlTemplate>
                  </Setter.Value>
                </Setter>
              </Style>
            </ListView.ItemContainerStyle>
          </ListView>
        </StackPanel>
      </Border>
      
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- BARRE D'ACTION (Statut + Bouton Export) -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <DockPanel LastChildFill="False" Margin="0,8,0,0">
        <!-- Message de statut (erreurs, avertissements) -->
        <TextBlock Name="ExportStatusText"
                   VerticalAlignment="Center"
                   Margin="0,0,8,0"
                   TextWrapping="Wrap"
                   Width="Auto"
                   DockPanel.Dock="Left"
                   Foreground="Red"
                   Text="Sélectionnez un dossier de destination valide."/>
        
        <!-- Bouton pour lancer l'export -->
        <Button Name="ExportButton"
                Content="Exporter"
                Height="32"
                MinWidth="120"
                HorizontalAlignment="Right"
                DockPanel.Dock="Right"
                IsEnabled="False"/>
      </DockPanel>
    </StackPanel>
  </ControlTemplate>
</ResourceDictionary>
