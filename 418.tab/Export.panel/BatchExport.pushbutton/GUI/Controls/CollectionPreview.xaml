<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <ControlTemplate x:Key="CollectionPreviewTemplate" TargetType="ContentControl">
    <ControlTemplate.Resources>
      <!-- Convertisseur Boolean vers Visibility -->
      <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

      <Style x:Key="FluentGroupExpanderStyle" TargetType="{x:Type Expander}">
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
        <Setter Property="BorderThickness" Value="0,0,0,1"/>
        <Setter Property="BorderBrush" Value="{DynamicResource ControlBorderBrush}"/>
        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        <Setter Property="VerticalContentAlignment" Value="Stretch"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type Expander}">
                    <Border BorderThickness="{TemplateBinding BorderThickness}" 
                            BorderBrush="{TemplateBinding BorderBrush}"
                            Background="{TemplateBinding Background}">
                        <DockPanel>
                            <ToggleButton x:Name="HeaderSite"
                                          DockPanel.Dock="Top"
                                          Background="Transparent"
                                          Content="{TemplateBinding Header}"
                                          ContentTemplate="{TemplateBinding HeaderTemplate}"
                                          ContentTemplateSelector="{TemplateBinding HeaderTemplateSelector}"
                                          Foreground="{TemplateBinding Foreground}"
                                          FontWeight="{TemplateBinding FontWeight}"
                                          FontStyle="{TemplateBinding FontStyle}"
                                          FontSize="{TemplateBinding FontSize}"
                                          FontFamily="{TemplateBinding FontFamily}"
                                          Padding="10,5"
                                          HorizontalContentAlignment="Stretch"
                                          IsChecked="{Binding IsExpanded, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="{x:Type ToggleButton}">
                                        <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- Chevron Icon -->
                                                <Border Width="24" Height="24" Background="Transparent">
                                                    <Path x:Name="arrow"
                                                          Data="M 0 0 L 4 4 L 0 8"
                                                          Stroke="{TemplateBinding Foreground}"
                                                          StrokeThickness="1.5"
                                                          HorizontalAlignment="Center"
                                                          VerticalAlignment="Center"
                                                          RenderTransformOrigin="0.5,0.5">
                                                        <Path.RenderTransform>
                                                            <RotateTransform Angle="0"/>
                                                        </Path.RenderTransform>
                                                    </Path>
                                                </Border>

                                                <!-- Header Content -->
                                                <ContentPresenter Grid.Column="1" 
                                                                  Content="{TemplateBinding Content}" 
                                                                  ContentTemplate="{TemplateBinding ContentTemplate}" 
                                                                  VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource ControlFillHoverBrush}"/>
                                                <Setter Property="Cursor" Value="Hand"/>
                                            </Trigger>
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter TargetName="arrow" Property="RenderTransform">
                                                    <Setter.Value>
                                                        <RotateTransform Angle="90"/>
                                                    </Setter.Value>
                                                </Setter>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <ContentPresenter x:Name="ExpandSite"
                                              DockPanel.Dock="Bottom"
                                              Focusable="false"
                                              HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              Margin="{TemplateBinding Padding}"
                                              Visibility="Collapsed"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </DockPanel>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsExpanded" Value="true">
                            <Setter Property="Visibility" TargetName="ExpandSite" Value="Visible"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
        <Style.Triggers>
            <Trigger Property="IsEnabled" Value="False">
                <Setter Property="Background" Value="#3f4655"/>
            </Trigger>
        </Style.Triggers>
      </Style>
    </ControlTemplate.Resources>
    <StackPanel>
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- EN-TÊTE ET PROGRESSION -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <TextBlock Text="Recapitulatif : " 
                  Foreground="{DynamicResource TextPrimaryBrush}"
                  FontWeight="Bold" Margin="0,0,0,6"/>
      
      <!-- Barre de progression de l'export -->
      <ProgressBar Name="ExportProgressBar"
                   Height="24" Minimum="0"
                   Maximum="100" Value="0" Margin="0,4,0,8"/>
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- TABLEAU DE PRÉVISUALISATION DES COLLECTIONS -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <Border BorderThickness="0" Margin="0,0,0,8">
        <StackPanel>
          <!-- Compteur de collections et éléments -->
          <TextBlock Name="PreviewCounterText"
                     Margin="0,0,0,6"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     Text="Collections: 0 • Éléments: 0"/>
          
          <!-- ListView avec GridView (style tableau) -->
          <ListView Name="CollectionGrid"
                    Height="200"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                    BorderThickness="1"
                    BorderBrush="{DynamicResource ControlBorderBrush}">
            <ListView.GroupStyle>
              <GroupStyle>
                <GroupStyle.ContainerStyle>
                  <Style TargetType="{x:Type GroupItem}">
                    <Setter Property="Template">
                      <Setter.Value>
                        <ControlTemplate TargetType="{x:Type GroupItem}">
                          <Expander Style="{StaticResource FluentGroupExpanderStyle}"
                                    IsExpanded="False"
                                    IsEnabled="{Binding Items[0][CollectionIsExported]}">
                            <Expander.Header>
                                <Grid Height="25" Width="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListView}}, Path=ActualWidth}">
                                    <Grid.ColumnDefinitions>
                                      <ColumnDefinition Width="100"/>
                                      <ColumnDefinition Width="350"/>
                                      <ColumnDefinition Width="100"/>
                                      <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Content -->
                                    <TextBlock Grid.Column="0" Text="{Binding Name}"
                                              FontStyle="Italic" VerticalAlignment="Center" Margin="5,0"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Items[0][CollectionPreviewName]}" 
                                              FontWeight="Bold" VerticalAlignment="Center" Margin="5,0" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="2" Text="{Binding Items[0][SheetCount], StringFormat='{}{0} feuilles'}"
                                              FontStyle="Italic"  VerticalAlignment="Center" Margin="5,0"/>
                                    <TextBlock Grid.Column="3" Text="{Binding Items[0][CollectionExportInfo]}" 
                                              FontSize="10" VerticalAlignment="Center" Margin="5,0" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </Grid>
                            </Expander.Header>
                            <ItemsPresenter />
                          </Expander>
                        </ControlTemplate>
                      </Setter.Value>
                    </Setter>
                  </Style>
                </GroupStyle.ContainerStyle>
              </GroupStyle>
            </ListView.GroupStyle>
            <ListView.View>
              <GridView AllowsColumnReorder="False">
                
                <!-- Colonne 2: View/Sheet Number -->
                <GridViewColumn Header="numéro" Width="60" DisplayMemberBinding="{Binding [SheetNumber]}"/>

                <!-- Colonne 3b: Preview Name -->
                <GridViewColumn Header="nom d'export" Width="320" DisplayMemberBinding="{Binding [PreviewNom]}"/>
                
                <!-- Colonne 4: Format -->
                <GridViewColumn Header="Format" Width="60" DisplayMemberBinding="{Binding [Format]}"/>
                
                <!-- Colonne 5: Size -->
                <GridViewColumn Header="Taille" Width="50" DisplayMemberBinding="{Binding [Size]}"/>
                
                <!-- Colonne 6: Orientation -->
                <GridViewColumn Header="Orientation" Width="80" DisplayMemberBinding="{Binding [Orientation]}"/>

                <!-- Colonne 7: Progress -->
                <GridViewColumn Header="Progress" Width="120">
                  <GridViewColumn.CellTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding [Progress]}" 
                                 Foreground="{Binding [ProgressColor]}"/>
                    </DataTemplate>
                  </GridViewColumn.CellTemplate>
                </GridViewColumn>
              </GridView>
            </ListView.View>
          </ListView>
        </StackPanel>
      </Border>
      
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- BARRE D'ACTION (Statut + Bouton Export) -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <DockPanel LastChildFill="False" Margin="0,8,0,0">
        <!-- Message de statut (erreurs, avertissements) -->
        <TextBlock Name="ExportStatusText"
                   VerticalAlignment="Center"
                   Margin="0,0,8,0"
                   TextWrapping="Wrap"
                   Width="Auto"
                   DockPanel.Dock="Left"
                   Foreground="Red"
                   Text="Sélectionnez un dossier de destination valide."/>
        
        <!-- Bouton pour lancer l'export -->
        <Button Name="ExportButton"
                Content="Exporter"
                Height="32"
                MinWidth="120"
                HorizontalAlignment="Right"
                DockPanel.Dock="Right"
                IsEnabled="False"/>
      </DockPanel>
    </StackPanel>
  </ControlTemplate>
</ResourceDictionary>
